# Life OS - Caddyfile
# Reverse Proxy Configuration for all services

# ═══════════════════════════════════════════════════════════════
# GLOBAL OPTIONS
# ═══════════════════════════════════════════════════════════════
{
	# Email für Let's Encrypt (für Production)
	# email {$ACME_EMAIL:admin@example.com}
	
	# Für lokale Entwicklung: selbstsignierte Zertifikate
	local_certs
	
	# Admin API deaktivieren (Sicherheit)
	admin off
}

# ═══════════════════════════════════════════════════════════════
# LOCAL DEVELOPMENT
# ═══════════════════════════════════════════════════════════════

# Dashboard (Frontend)
dashboard.localhost {
	reverse_proxy frontend:3000
	
	# Kompression
	encode gzip zstd
	
	# Security Headers
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-XSS-Protection "1; mode=block"
		Referrer-Policy strict-origin-when-cross-origin
		-Server
	}
}

# n8n (Workflow Automation)
n8n.localhost {
	reverse_proxy n8n:5678
	
	# WebSocket Support für n8n
	@websockets {
		header Connection *Upgrade*
		header Upgrade websocket
	}
	reverse_proxy @websockets n8n:5678
	
	# Security Headers
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options SAMEORIGIN
		-Server
	}
}

# Supabase API
api.localhost {
	reverse_proxy supabase-kong:8000
	
	# CORS Headers
	header {
		Access-Control-Allow-Origin *
		Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Authorization, Content-Type, apikey, x-client-info"
		Access-Control-Max-Age 86400
		-Server
	}
	
	# Handle preflight requests
	@options method OPTIONS
	respond @options 204
}

# Supabase Studio (Admin UI)
studio.localhost {
	reverse_proxy supabase-studio:3000
	
	# Basic Auth für Sicherheit
	basicauth {
		{$DASHBOARD_USERNAME:admin} {$DASHBOARD_PASSWORD_HASH}
	}
	
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options SAMEORIGIN
		-Server
	}
}

# Supabase Storage
storage.localhost {
	reverse_proxy supabase-storage:5000
	
	# Erhöhtes Upload-Limit
	request_body {
		max_size 50MB
	}
}


# ═══════════════════════════════════════════════════════════════
# PRODUCTION (Hetzner) - Später aktivieren
# Ersetze {$DOMAIN} durch deine Domain, z.B. lifeos.example.com
# ═══════════════════════════════════════════════════════════════

# dashboard.{$DOMAIN} {
# 	reverse_proxy frontend:3000
# 	
# 	encode gzip zstd
# 	
# 	header {
# 		X-Content-Type-Options nosniff
# 		X-Frame-Options DENY
# 		X-XSS-Protection "1; mode=block"
# 		Referrer-Policy strict-origin-when-cross-origin
# 		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
# 		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: https:;"
# 		-Server
# 	}
# }
# 
# n8n.{$DOMAIN} {
# 	reverse_proxy n8n:5678
# 	
# 	@websockets {
# 		header Connection *Upgrade*
# 		header Upgrade websocket
# 	}
# 	reverse_proxy @websockets n8n:5678
# 	
# 	# Rate Limiting für Webhooks
# 	rate_limit {
# 		zone webhooks {
# 			key {remote_host}
# 			events 100
# 			window 1m
# 		}
# 	}
# }
# 
# api.{$DOMAIN} {
# 	reverse_proxy supabase-kong:8000
# 	
# 	header {
# 		Access-Control-Allow-Origin https://dashboard.{$DOMAIN}
# 		Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
# 		Access-Control-Allow-Headers "Authorization, Content-Type, apikey, x-client-info"
# 		Access-Control-Max-Age 86400
# 		Strict-Transport-Security "max-age=31536000; includeSubDomains"
# 		-Server
# 	}
# }
# 
# studio.{$DOMAIN} {
# 	reverse_proxy supabase-studio:3000
# 	
# 	# IP Whitelist für Studio (nur deine IPs)
# 	@allowed {
# 		remote_ip 1.2.3.4/32  # Deine IP hier
# 	}
# 	handle @allowed {
# 		reverse_proxy supabase-studio:3000
# 	}
# 	handle {
# 		respond "Access Denied" 403
# 	}
# }
