# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Life-OS (Felix-AI) is a self-hosted personal life management platform integrating wealth tracking, productivity, health monitoring, fitness coaching, AI copilot, and document processing. It's a Docker-based microservices application deployed at life-os.fwanner.de.

## Tech Stack

- **Frontend**: React 18 + TypeScript + Vite + TailwindCSS + Zustand + React Query
- **Backend**: Supabase (PostgreSQL 15 + PostgREST + GoTrue + Kong API Gateway)
- **Automation**: n8n (21 workflows for wealth, health, productivity, AI copilot)
- **Reverse Proxy**: Caddy with automatic HTTPS
- **Document Processing**: Docling (IBM)
- **Database Extensions**: pgvector for AI embeddings, RLS for security

## Build & Development Commands

```bash
# Frontend development (hot reload)
cd frontend && npm install && npm run dev

# Frontend type checking and linting
npm run type-check
npm run lint

# Build frontend for production
npm run build
# Or use the script:
bash scripts/build-frontend.sh

# Start all services
docker compose up -d

# Start with production overrides
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Import n8n workflows (auto-runs with n8n-init, or manually)
bash scripts/import-n8n-workflows.sh --wait

# Run preflight checks before deployment
bash scripts/preflight.sh

# Backup database and volumes
bash scripts/backup.sh

# View logs
docker compose logs -f [service-name]
```

## Architecture

```
Caddy (80/443) → Routes to services:
├── dashboard.* → Frontend (React/Nginx)
├── api.* → Kong (8000) → PostgREST → PostgreSQL
├── n8n.* → n8n (5678)
├── studio.* → Supabase Studio
├── storage.* → Supabase Storage
├── realtime.* → WebSocket service
├── portainer.* → Docker management
└── docling.* → Document processing
```

**Frontend Route Structure**: App.tsx contains main router with protected routes wrapping Layout (Header + Sidebar) containing Dashboard, Wealth, Productivity, Health, Goals, Journal, Fitness, Training, WeeklyUpdate pages.

**Key Frontend Patterns**:
- Custom hooks in `src/hooks/` (useAuth, useWealth, useDashboard, useProperties)
- Zustand stores in `src/stores/`
- React Query for data fetching with realtime subscriptions
- Supabase client in `src/lib/supabase.ts`
- TypeScript strict mode enabled
- Path alias: `@/` maps to `src/` (configured in vite.config.ts and tsconfig.json)

**Frontend Component Structure**:
- `src/components/` - Feature-based organization (dashboard, wealth, productivity, health, fitness, goals, journal, training)
- `src/pages/` - Route-level components (Dashboard, Wealth, Productivity, Health, Goals, Journal, Fitness, Training, WeeklyUpdate)
- `src/contexts/` - React contexts (ThemeContext, AuthContext)
- `src/types/` - TypeScript definitions including generated Supabase types

## Database

PostgreSQL with 30 migrations in `supabase/migrations/`. Key schemas:
- **Wealth**: accounts, transactions, properties, tenants, loans, ETFs, snapshots
- **Health**: daily logs, supplements, vitals, Garmin sync
- **Productivity**: tasks, calendar events, Microsoft Todo sync
- **Fitness**: workouts, habits, streaks, gamification points system
- **AI**: conversations, insights, vector embeddings (pgvector)

Apply new migrations:
```bash
docker exec -i lifeos-db psql -U postgres < supabase/migrations/00029_your_change.sql
```

## n8n Workflows

21 workflows in `n8n/workflows/` organized by module:
- 01-08: Wealth (bank sync, transactions, invoices, ETF prices, snapshots)
- 09-12: Productivity (Microsoft Todo, Plaud meetings, Outlook, scans)
- 13-16: Health (Garmin sync, supplement/training reminders, readiness)
- 17-20: AI Copilot (morning briefing, weekly review, insights, Telegram)
- 21: Document indexing with vector embeddings

Edit workflows in n8n UI, export as JSON, replace files in `n8n/workflows/`.

## Configuration

- `.env` - All secrets and configuration (generated by scripts/setup.sh)
- `docker-compose.yml` - Base service definitions (14 services)
- `docker-compose.prod.yml` - Production overrides (resources, logging)
- `caddy/Caddyfile` - Routing for 8 subdomains
- `supabase/kong.yml` - API gateway routing
- `frontend/vite.config.ts` - Build configuration

## External Integrations

- BankingHub (Buchhaltungsbutler) - Bank accounts
- GetMyInvoices - Invoice management
- Trade Republic - Stock portfolio
- Microsoft 365 (Outlook, Todo)
- Garmin Connect - Fitness data
- OpenAI API - AI features
- Telegram Bot - Notifications

## Testing

No test framework is configured. Code quality is enforced via:
- TypeScript strict mode (no `any` types, strict null checks)
- ESLint for linting
- Type checking via `npm run type-check`

## Troubleshooting

```bash
# Check n8n workflow import
docker logs lifeos-n8n-init

# Check n8n health
curl http://localhost:5678/healthz

# Check service health
docker compose ps

# Restart a specific service
docker compose restart [service-name]

# Check database connectivity
docker exec -it lifeos-db psql -U postgres -c "SELECT 1"
```

## Important Notes

- JWT_SECRET must never change after initial setup (invalidates all sessions)
- N8N credentials must be configured in UI after workflow import (see `n8n/README.md` for credential setup details)
- All services require Caddy for external access (HTTPS termination)
- Frontend runs on Nginx with SPA routing configured in nginx.conf
- Database uses RLS (Row-Level Security) - new tables need RLS policies for user data isolation
- Service role credentials bypass RLS - use only in backend/n8n workflows
- Migrations are incremental - create new files, never edit existing ones
- n8n documentation (`n8n/README.md`) is in German
